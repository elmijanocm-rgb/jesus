<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Aplicación PWA de Conteo de Cajas | Gestión Eficiente de Inventario</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Aplicación web progresiva moderna para el conteo eficiente de cajas y palets con sistema de bloques automático y totales en tiempo real. Optimizada para dispositivos móviles y escritorio.">
    <meta name="keywords" content="conteo, cajas, palets, inventario, PWA, aplicación web, gestión, logística, almacén">
    <meta name="author" content="Desarrollador PWA">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Aplicación PWA de Conteo de Cajas">
    <meta property="og:description" content="Aplicación web progresiva moderna para el conteo eficiente de cajas y palets con sistema de bloques automático y totales en tiempo real.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tu-usuario.github.io/nombre-repositorio/">
    <meta property="og:image" content="./icon-512.png">
    <meta property="og:locale" content="es_ES">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Aplicación PWA de Conteo de Cajas">
    <meta name="twitter:description" content="Aplicación web progresiva moderna para el conteo eficiente de cajas y palets.">
    <meta name="twitter:image" content="./icon-512.png">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4caf50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Conteo PWA">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Conteo PWA">
    <meta name="msapplication-TileColor" content="#4caf50">
    <meta name="msapplication-config" content="./browserconfig.xml">
    
    <!-- Optimizaciones móviles adicionales -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-orientations" content="portrait landscape">
    <meta name="screen-orientation" content="natural">
    <meta name="mobile-web-app-title" content="Conteo PWA">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="msapplication-navbutton-color" content="#4caf50">
    
    <!-- Cache Control AGRESIVO - VERSION 3.0.0 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="Tue, 28 Jan 2025 15:25:00 GMT">
    <meta name="cache-version" content="3.0.0">
    <meta name="timestamp" content="1756412700">
    <meta http-equiv="If-Modified-Since" content="0">
    <meta http-equiv="If-None-Match" content="0">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css?v=3.4.0&t=1757093500&mobile=responsive&table=fixed">
    <link rel="stylesheet" href="emergency-mobile.css?v=3.3.0&t=1756577992&editable=quantities&historial=fixed">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SCRIPT DE LIMPIEZA FORZADA -->
    <!-- Script force-refresh.js removido para evitar actualizaciones constantes -->
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Debug info removed for clean appearance -->
    
    <div class="app-container">
        <main class="content">
            <!-- Página 1: Resumen del Conteo -->
            <section id="resumen" class="page active">
                <div class="header">
                    <div class="header-top">
                        <h1><i class="fas fa-box"></i> Cuenta de Cajas</h1>
                    </div>
                    <nav class="main-nav">
                        <div class="nav-item active" data-page="resumen">
                            <i class="fas fa-home"></i>
                            <span>Inicio</span>
                        </div>
                        <div class="nav-item" data-page="conteos">
                            <i class="fas fa-history"></i>
                            <span>Conteos</span>
                        </div>
                        <div class="nav-item" data-page="registros">
                            <i class="fas fa-archive"></i>
                            <span>Registros</span>
                        </div>
                        <div class="nav-item" data-page="administrar">
                            <i class="fas fa-cog"></i>
                            <span>Crear Caja</span>
                        </div>
                    </nav>
                </div>
                <div class="card">
                    <h2>Resumen del Conteo</h2>
                    <div class="summary-info">
                        <div class="summary-item">
                            <span class="label">Total de Cajas:</span>
                            <span class="value" id="total-cajas">6</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Estado del Bloque:</span>
                            <span class="value" id="bloque-estado">0/4 filas</span>
                        </div>
                    </div>
                    <button class="btn primary-btn" id="agregar-conteo-btn"><i class="fas fa-plus"></i> Agregar Conteo</button>
                </div>

                <div class="card">
                    <h2>Tipos de Caja</h2>
                    <div class="box-types">
                        <!-- Las cajas creadas por el usuario aparecerán aquí dinámicamente -->
                    </div>
                </div>
            </section>

            <!-- Página 2: Crear Caja -->
            <section id="administrar" class="page">
                <div class="header">
                    <div class="header-top">
                        <h1><i class="fas fa-box"></i> Cuenta de Cajas</h1>
                        <div class="header-actions">
                            <button class="btn primary-btn" id="agregar-contenedor-btn"><i class="fas fa-plus"></i> Agregar Cajas</button>
                        </div>
                    </div>
                    <nav class="main-nav">
                        <div class="nav-item" data-page="resumen">
                            <i class="fas fa-home"></i>
                            <span>Inicio</span>
                        </div>
                        <div class="nav-item" data-page="conteos">
                            <i class="fas fa-history"></i>
                            <span>Conteos</span>
                        </div>
                        <div class="nav-item" data-page="registros">
                            <i class="fas fa-archive"></i>
                            <span>Registros</span>
                        </div>
                        <div class="nav-item active" data-page="administrar">
                            <i class="fas fa-cog"></i>
                            <span>Crear Caja</span>
                        </div>
                    </nav>
                </div>
                <h2 class="section-title">Crear Caja</h2>
                
                <!-- Formulario para agregar nuevo contenedor -->
                <div class="card" id="nuevo-contenedor-form" style="display: none;">
                    <h3>Agregar Nuevo Contenedor</h3>
                    <div class="form-container">
                        <div class="form-group">
                            <label for="nombre-contenedor">Nombre del Contenedor</label>
                            <input type="text" id="nombre-contenedor" placeholder="Ej: Caja Verde Grande">
                        </div>
                        <div class="form-group">
                            <label for="tipo-contenedor">Tipo de caja</label>
                            <input type="text" id="tipo-contenedor" placeholder="Ej: Juego, Película, Libro...">
                        </div>
                        <div class="form-group">
                            <label for="descripcion-contenedor">Descripción/Medidas</label>
                            <input type="text" id="descripcion-contenedor" placeholder="Ej: 45X30">
                        </div>
                        <div class="form-group">
                            <label for="peso-tara">Peso para la tara (Kg)</label>
                            <input type="text" id="peso-tara" placeholder="Ej: 1.5">
                        </div>
                        <div class="form-group">
                            <label>Imagen del Contenedor</label>
                            <div class="image-selection">
                                <div class="image-option-group">
                                    <input type="radio" id="use-color" name="image-type" value="color" checked>
                                    <label for="use-color">Usar color predefinido</label>
                                    <select id="color-contenedor">
                                        <option value="green-box">Verde</option>
                                        <option value="green-small-box">Verde Claro</option>
                                        <option value="red-box">Rojo</option>
                                        <option value="red-small-box">Rojo Claro</option>
                                        <option value="blue-box">Azul</option>
                                        <option value="ifco-box">Gris</option>
                                    </select>
                                </div>
                                <div class="image-option-group">
                                    <input type="radio" id="use-image" name="image-type" value="image">
                                    <label for="use-image">Subir imagen personalizada</label>
                                    <input type="file" id="imagen-contenedor" accept="image/*" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn outline-btn" id="cancelar-contenedor">Cancelar</button>
                            <button class="btn primary-btn" id="guardar-contenedor">Guardar Contenedor</button>
                        </div>
                    </div>
                </div>

                <!-- Las cajas creadas por el usuario aparecerán aquí dinámicamente -->
            </section>

            <!-- Página 3: Historial de Conteos -->
            <section id="conteos" class="page">
                <div class="header">
                    <div class="header-top">
                        <h1><i class="fas fa-history"></i> Historial de Conteos</h1>
                    </div>
                    <nav class="main-nav">
                        <div class="nav-item" data-page="resumen">
                            <i class="fas fa-home"></i>
                            <span>Inicio</span>
                        </div>
                        <div class="nav-item active" data-page="conteos">
                            <i class="fas fa-history"></i>
                            <span>Conteos</span>
                        </div>
                        <div class="nav-item" data-page="registros">
                            <i class="fas fa-archive"></i>
                            <span>Registros</span>
                        </div>
                        <div class="nav-item" data-page="administrar">
                            <i class="fas fa-cog"></i>
                            <span>Crear Caja</span>
                        </div>
                    </nav>
                </div>
                <div class="card">
                    <div class="conteos-header">
                        <p class="info-text">Aquí puedes ver tus conteos guardados.</p>
                        
                        <!-- Visualización de cajas individuales con totales -->
                        <div class="individual-boxes-display" id="individual-boxes-display">
                            <!-- Las cajas individuales con sus totales aparecerán aquí dinámicamente -->
                        </div>
                        
                        <div class="summary-boxes">
                            <div class="summary-box">
                                <div class="summary-title">Total General</div>
                                <div class="summary-value" id="total-general-display">0</div>
                                <div class="summary-label">cajas</div>
                            </div>
                            <div class="summary-box">
                                <div class="summary-title">Total Palets</div>
                                <div class="summary-value" id="total-palets-display">0</div>
                                <div class="summary-label">palets</div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <!-- Los encabezados se generan dinámicamente por JavaScript -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los datos se generan dinámicamente por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-actions">
                        <button class="btn outline-btn" id="exportar-historial-pdf-btn" style="background-color: #28a745; color: white;"><i class="fas fa-file-export"></i> Exportar a PDF</button>
                        <button class="btn danger-btn" id="archivar-limpiar-btn" style="background-color: #dc3545; color: white;"><i class="fas fa-archive"></i> Archivar y Limpiar</button>
                    </div>
                </div>
            </section>

            <!-- Página 4: Registros Archivados -->
            <section id="registros" class="page">
                <div class="header">
                    <div class="header-top">
                        <h1><i class="fas fa-box"></i> Cuenta de Cajas</h1>
                        <div class="header-actions">
                            <button class="btn outline-btn" id="exportar-registros-pdf-btn"><i class="fas fa-file-export"></i> Exportar a PDF</button>
                        </div>
                    </div>
                    <nav class="main-nav">
                        <div class="nav-item" data-page="resumen">
                            <i class="fas fa-home"></i>
                            <span>Inicio</span>
                        </div>
                        <div class="nav-item" data-page="conteos">
                            <i class="fas fa-history"></i>
                            <span>Conteos</span>
                        </div>
                        <div class="nav-item active" data-page="registros">
                            <i class="fas fa-archive"></i>
                            <span>Registros</span>
                        </div>
                        <div class="nav-item" data-page="administrar">
                            <i class="fas fa-cog"></i>
                            <span>Crear Caja</span>
                        </div>
                    </nav>
                </div>
                <div class="card">
                    <h2>Registros Archivados</h2>
                    
                    <div class="archived-info">
                        <h3>Historial de Totales</h3>
                        <p>Estos son los resultados totales de los históricos que has archivado.</p>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha Archivo</th>
                                    <th>CVG</th>
                                    <th>CVP</th>
                                    <th>CRG</th>
                                    <th>CRP</th>
                                    <th>CVGB</th>
                                    <th>CAP</th>
                                    <th>IFCO</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>16/08/23 22:27</td>
                                    <td>5</td>
                                    <td>11</td>
                                    <td>14</td>
                                    <td>12</td>
                                    <td>2</td>
                                    <td>0</td>
                                    <td>1</td>
                                    <td>
                                        <button class="btn small-btn"><i class="fas fa-eye"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- FORCE COMPLETE REFRESH Script -->
    <script>
        // VERSION CHECK - Versión 3.0 (sin auto-reload)
        (function() {
            const currentVersion = '3.0';
            const lastVersion = localStorage.getItem('app_version');
            
            // Solo marcar la versión si no existe, sin forzar recarga
            if (!lastVersion) {
                console.log('Primera carga - estableciendo versión 3.0');
                localStorage.setItem('app_version', currentVersion);
            }
        })();
    </script>
    
    <!-- Force Refresh Script DESHABILITADO para evitar bucles -->
    <!-- <script src="force-refresh.js?v=30"></script> -->
    
    <!-- Optimizaciones de rendimiento -->
    <script src="performance-optimizations.js?v=3.2.0"></script>
    
    <!-- Cache Buster Script -->
    <script>
        // Forzar limpieza de caché y recarga si es necesario
        const currentVersion = '3.3.0-historial-fixed';
        const storedVersion = localStorage.getItem('app-version');
        
        if (storedVersion !== currentVersion) {
            // Limpiar caché del navegador
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // Limpiar localStorage relacionado con caché
            Object.keys(localStorage).forEach(key => {
                if (key.includes('cache') || key.includes('version')) {
                    localStorage.removeItem(key);
                }
            });
            
            localStorage.setItem('app-version', currentVersion);
            
            // Recargar la página después de limpiar caché
            setTimeout(() => {
                window.location.reload(true);
            }, 500);
        }
    </script>
    
    <!-- Main Script -->
    <script src="script.js?v=3.3.0&t=1756577992&editable=quantities&delete=enabled&historial=fixed"></script>
    
    <!-- FORZAR ALINEACIÓN A LA IZQUIERDA - OVERRIDE ULTRA AGRESIVO -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para forzar alineación izquierda de títulos de bloques
        function forceLeftAlignment() {
            // Buscar por clase
            const blockTitles = document.querySelectorAll('.block-title-row');
            blockTitles.forEach(function(row) {
                row.style.setProperty('text-align', 'left', 'important');
                const cells = row.querySelectorAll('td');
                cells.forEach(function(cell) {
                    cell.style.setProperty('text-align', 'left', 'important');
                    cell.style.setProperty('padding-left', '10px', 'important');
                });
            });
            
            // Buscar por color de fondo azul (BLOQUE ACTIVO)
            const blueTitles = document.querySelectorAll('tr[style*="background-color: rgb(33, 150, 243)"], tr[style*="background-color: #2196F3"]');
            blueTitles.forEach(function(row) {
                row.style.setProperty('text-align', 'left', 'important');
                const cells = row.querySelectorAll('td');
                cells.forEach(function(cell) {
                    cell.style.setProperty('text-align', 'left', 'important');
                    cell.style.setProperty('padding-left', '10px', 'important');
                });
            });
            
            // Buscar por color de fondo verde (BLOQUE CERRADO)
            const greenTitles = document.querySelectorAll('tr[style*="background-color: rgb(76, 175, 80)"], tr[style*="background-color: #4CAF50"]');
            greenTitles.forEach(function(row) {
                row.style.setProperty('text-align', 'left', 'important');
                const cells = row.querySelectorAll('td');
                cells.forEach(function(cell) {
                    cell.style.setProperty('text-align', 'left', 'important');
                    cell.style.setProperty('padding-left', '10px', 'important');
                });
            });
            
            // Buscar por contenido de texto
            const allRows = document.querySelectorAll('tr');
            allRows.forEach(function(row) {
                const text = row.textContent || row.innerText;
                if (text.includes('BLOQUE ACTIVO') || text.includes('BLOQUE') && text.includes('CERRADO')) {
                    row.style.setProperty('text-align', 'left', 'important');
                    const cells = row.querySelectorAll('td');
                    cells.forEach(function(cell) {
                        cell.style.setProperty('text-align', 'left', 'important');
                        cell.style.setProperty('padding-left', '10px', 'important');
                    });
                }
            });
        }
        
        // Ejecutar inmediatamente
        forceLeftAlignment();
        
        // Ejecutar cada 200ms para asegurar que se aplique
        setInterval(forceLeftAlignment, 200);
        
        // Observer para detectar cambios en el DOM
        const observer = new MutationObserver(function() {
            setTimeout(forceLeftAlignment, 50);
        });
        observer.observe(document.body, { childList: true, subtree: true, attributes: true, attributeOldValue: true });
    });
    </script>
    
    <!-- PWA Service Worker Registration - DESHABILITADO COMPLETAMENTE -->
    <!--
    <script>
        // Service Worker registration removed for clean appearance
        
        // Detectar si la app puede ser instalada
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('PWA puede ser instalada');
        });
        
        // Función para mostrar prompt de instalación (opcional)
        function mostrarInstallPrompt() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario aceptó instalar la PWA');
                    }
                    deferredPrompt = null;
                });
            }
        }
    </script>
    -->

    <!-- Service Worker and cache management removed for clean appearance -->

    <!-- Modal del Teclado Numérico -->
    <div id="numeric-keypad-modal" class="modal" style="display: none;">
        <div class="modal-content numeric-keypad">
            <div class="keypad-header">
                <h3 id="keypad-title">Ingresa la cantidad</h3>
                <button class="close-btn" id="close-keypad">&times;</button>
            </div>
            <div class="keypad-display">
                <input type="text" id="keypad-input" readonly placeholder="0">
            </div>
            <div class="keypad-buttons">
                <button class="keypad-btn number-btn" data-number="7">7</button>
                <button class="keypad-btn number-btn" data-number="8">8</button>
                <button class="keypad-btn number-btn" data-number="9">9</button>
                <button class="keypad-btn action-btn" id="keypad-clear">C</button>
                
                <button class="keypad-btn number-btn" data-number="4">4</button>
                <button class="keypad-btn number-btn" data-number="5">5</button>
                <button class="keypad-btn number-btn" data-number="6">6</button>
                <button class="keypad-btn action-btn" id="keypad-backspace">⌫</button>
                
                <button class="keypad-btn number-btn" data-number="1">1</button>
                <button class="keypad-btn number-btn" data-number="2">2</button>
                <button class="keypad-btn number-btn" data-number="3">3</button>
                <button class="keypad-btn confirm-btn" id="keypad-confirm" rowspan="2">✓</button>
                
                <button class="keypad-btn number-btn zero-btn" data-number="0">0</button>
                <button class="keypad-btn action-btn" id="keypad-cancel">✗</button>
            </div>
        </div>
    </div>

</body>
</html>