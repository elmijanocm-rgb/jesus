<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de la Aplicaci√≥n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico de la Aplicaci√≥n de Conteo</h1>
    
    <div class="diagnostic-container">
        <h2>Estado General</h2>
        <div id="general-status"></div>
        <button onclick="runGeneralDiagnostic()">Ejecutar Diagn√≥stico General</button>
    </div>

    <div class="diagnostic-container">
        <h2>Pruebas de Funcionalidad</h2>
        <div id="functionality-tests"></div>
        <button onclick="testTableGeneration()">Probar Generaci√≥n de Tabla</button>
        <button onclick="testMobileFunctionality()">Probar Funcionalidad M√≥vil</button>
        <button onclick="testColspanCalculation()">Probar C√°lculo de Colspan</button>
    </div>

    <div class="diagnostic-container">
        <h2>Consola de Errores</h2>
        <div id="console-output" class="console-output"></div>
        <button onclick="clearConsole()">Limpiar Consola</button>
    </div>

    <script>
        // Capturar errores de JavaScript
        let consoleErrors = [];
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleLog = console.log;

        console.error = function(...args) {
            consoleErrors.push({type: 'error', message: args.join(' '), timestamp: new Date()});
            updateConsoleOutput();
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            consoleErrors.push({type: 'warning', message: args.join(' '), timestamp: new Date()});
            updateConsoleOutput();
            originalConsoleWarn.apply(console, args);
        };

        console.log = function(...args) {
            consoleErrors.push({type: 'log', message: args.join(' '), timestamp: new Date()});
            updateConsoleOutput();
            originalConsoleLog.apply(console, args);
        };

        function updateConsoleOutput() {
            const output = document.getElementById('console-output');
            output.innerHTML = consoleErrors.map(error => 
                `[${error.timestamp.toLocaleTimeString()}] ${error.type.toUpperCase()}: ${error.message}`
            ).join('\n');
            output.scrollTop = output.scrollHeight;
        }

        function addResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = message;
            container.appendChild(result);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function runGeneralDiagnostic() {
            clearResults('general-status');
            
            // Verificar si el script principal est√° cargado
            try {
                if (typeof userCreatedBoxes !== 'undefined') {
                    addResult('general-status', `‚úÖ userCreatedBoxes encontrado con ${userCreatedBoxes.length} cajas`, 'success');
                } else {
                    addResult('general-status', '‚ùå userCreatedBoxes no est√° definido', 'error');
                }
            } catch (e) {
                addResult('general-status', `‚ùå Error al acceder a userCreatedBoxes: ${e.message}`, 'error');
            }

            // Verificar localStorage
            try {
                const saved = localStorage.getItem('userCreatedBoxes');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    addResult('general-status', `‚úÖ localStorage contiene ${parsed.length} cajas`, 'success');
                } else {
                    addResult('general-status', '‚ö†Ô∏è No hay datos en localStorage', 'warning');
                }
            } catch (e) {
                addResult('general-status', `‚ùå Error al leer localStorage: ${e.message}`, 'error');
            }

            // Verificar elementos DOM
            const elements = [
                '#conteos .data-table thead tr',
                '#conteos .data-table tbody',
                '.box-types'
            ];

            elements.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    addResult('general-status', `‚úÖ Elemento encontrado: ${selector}`, 'success');
                } else {
                    addResult('general-status', `‚ùå Elemento no encontrado: ${selector}`, 'error');
                }
            });
        }

        function testTableGeneration() {
            clearResults('functionality-tests');
            
            try {
                // Simular la funci√≥n updateHistorialHeaders
                const thead = document.querySelector('#conteos .data-table thead tr');
                if (thead) {
                    addResult('functionality-tests', '‚úÖ Elemento thead encontrado', 'success');
                    
                    // Verificar si hay cajas para generar headers
                    if (typeof userCreatedBoxes !== 'undefined' && userCreatedBoxes.length > 0) {
                        const sortedBoxes = [...userCreatedBoxes].sort((a, b) => (a.position || 0) - (b.position || 0));
                        const cajasPalet = sortedBoxes.filter(box => box.nombre.toLowerCase().includes('palet'));
                        const cajasNormales = sortedBoxes.filter(box => !box.nombre.toLowerCase().includes('palet'));
                        
                        const ordenColumnas = [
                            'Fecha/Hora',
                            'Total',
                            ...cajasPalet.map(box => box.nombre),
                            ...cajasNormales.map(box => box.nombre)
                        ];
                        
                        addResult('functionality-tests', `‚úÖ Se generar√≠an ${ordenColumnas.length} columnas: ${ordenColumnas.join(', ')}`, 'success');
                        
                        // Calcular colspan esperado
                        const expectedColspan = ordenColumnas.length;
                        addResult('functionality-tests', `‚úÖ Colspan esperado para bloque activo: ${expectedColspan}`, 'success');
                        
                    } else {
                        addResult('functionality-tests', '‚ö†Ô∏è No hay cajas para generar headers', 'warning');
                    }
                } else {
                    addResult('functionality-tests', '‚ùå No se encontr√≥ el elemento thead', 'error');
                }
            } catch (e) {
                addResult('functionality-tests', `‚ùå Error en generaci√≥n de tabla: ${e.message}`, 'error');
            }
        }

        function testMobileFunctionality() {
            clearResults('functionality-tests');
            
            // Verificar si estamos en m√≥vil
            const isMobile = window.innerWidth <= 768;
            addResult('functionality-tests', `üì± Dispositivo m√≥vil detectado: ${isMobile ? 'S√≠' : 'No'} (ancho: ${window.innerWidth}px)`, isMobile ? 'warning' : 'success');
            
            // Verificar elementos m√≥viles
            const mobileElements = [
                '#numeric-keypad-modal',
                '.edit-input',
                '.editable-cell'
            ];
            
            mobileElements.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    addResult('functionality-tests', `‚úÖ Elementos m√≥viles encontrados: ${selector} (${elements.length})`, 'success');
                } else {
                    addResult('functionality-tests', `‚ö†Ô∏è Elementos m√≥viles no encontrados: ${selector}`, 'warning');
                }
            });
        }

        function testColspanCalculation() {
            clearResults('functionality-tests');
            
            try {
                if (typeof userCreatedBoxes !== 'undefined') {
                    const sortedBoxes = [...userCreatedBoxes].sort((a, b) => (a.position || 0) - (b.position || 0));
                    const cajasPalet = sortedBoxes.filter(box => box.nombre.toLowerCase().includes('palet'));
                    const cajasNormales = sortedBoxes.filter(box => !box.nombre.toLowerCase().includes('palet'));
                    
                    const ordenColumnasData = [
                        ...cajasPalet.map(box => box.nombre),
                        ...cajasNormales.map(box => box.nombre)
                    ];
                    
                    const calculatedColspan = ordenColumnasData.length + 2; // +2 para Fecha/Hora y Total
                    
                    addResult('functionality-tests', `üìä Cajas Palet: ${cajasPalet.length}`, 'success');
                    addResult('functionality-tests', `üì¶ Cajas Normales: ${cajasNormales.length}`, 'success');
                    addResult('functionality-tests', `üî¢ Total columnas de datos: ${ordenColumnasData.length}`, 'success');
                    addResult('functionality-tests', `üìè Colspan calculado: ${calculatedColspan}`, 'success');
                    
                    // Verificar si hay bloques activos
                    const activeBlocks = document.querySelectorAll('.block-title-row');
                    if (activeBlocks.length > 0) {
                        activeBlocks.forEach((block, index) => {
                            const actualColspan = block.querySelector('td').colSpan;
                            const isCorrect = actualColspan === calculatedColspan;
                            addResult('functionality-tests', 
                                `${isCorrect ? '‚úÖ' : '‚ùå'} Bloque ${index + 1}: colspan actual=${actualColspan}, esperado=${calculatedColspan}`, 
                                isCorrect ? 'success' : 'error'
                            );
                        });
                    } else {
                        addResult('functionality-tests', '‚ö†Ô∏è No se encontraron bloques activos en la tabla', 'warning');
                    }
                } else {
                    addResult('functionality-tests', '‚ùå userCreatedBoxes no est√° definido', 'error');
                }
            } catch (e) {
                addResult('functionality-tests', `‚ùå Error en c√°lculo de colspan: ${e.message}`, 'error');
            }
        }

        function clearConsole() {
            consoleErrors = [];
            updateConsoleOutput();
        }

        // Ejecutar diagn√≥stico inicial
        window.addEventListener('load', () => {
            setTimeout(() => {
                runGeneralDiagnostic();
                testTableGeneration();
                testColspanCalculation();
            }, 1000);
        });
    </script>
</body>
</html>